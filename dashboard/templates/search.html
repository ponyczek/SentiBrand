{% extends 'base.html' %}
{% block content %}
    <div class="dashboard-page">
        <div class="row equal-sides">
            <div class="col-sm-2 trim-right">
                {% include 'dashboard_navigation.html' %}
            </div>
            <div class="col-sm-10 trim-left extra-padding-bottom-160">
                <div class="dashboard-main card">
                    <div class="dashboard-search">
                        <h2 class="text-center">Perform Single Search</h2>
                        <div class="col-sm-12">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-search"></i></span>
                                <input type="text" class="form-control search-input" name="query_phrase"
                                       id="query_phrase"
                                       placeholder="Type the keyword, hashtag, phrase, user that you want to look for on Twitter">
                                <button class="btn btn-primary btn-round" id="search-btn">Search</button>
                                <button class="btn btn-default btn-round" onclick="pageReload()" disabled
                                        id="new_search_btn">New
                                    Search
                                </button>
                                <div id="clockdiv">
                                    <div>
                                        <span class="seconds"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane" id="messages" role="tabpanel" aria-expanded="true">
                                {% include 'phrase_map.html' %}
                                <div class="statistics-holder">
                                    {% include 'statistics.html' %}
                                    {% include 'phrase_timeline.html' %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";

        var socket = new WebSocket(ws_scheme + '://' + window.location.host + '/dashboard/search');
        var total_tweets = null;
        var total_locations = null;
        var top_location = "";
        var highest_polarity = -2;
        var lowest_polarity = 2;
        var polarity_sum = 0;
        var most_negative_tweet = {}; //so big that it must be overwritten
        var most_positive_tweet = {}; // so small that it must be overwritten
        var most_negative_tweet = {}; //so big that it must be overwritten
        var positive_tweets_count = 0;
        var neutral_tweets_count = 0;
        var negative_tweets_count = 0;

        var average_polarity_list = [];
        var tweets_per_pull_list = []; //list that contains number of tweets that came back from api
        var negative_count_list = [];
        var neutral_count_list = [];
        var positive_count_list = [];


        var calls_counter = 0;
        var last_tweet_id;
        var colours = [
            "#FF0000",
            "#FF1100",
            "#FF3400",
            "#FF4600",
            "#FF6900",
            "#FF7B00",
            "#FF9E00",
            "#FFAF00",
            "#FFD300",
            "#FFE400",
            "#F7FF00",
            "#FFFF00",
            "#E5FF00",
            "#C2FF00",
            "#B0FF00",
            "#8DFF00",
            "#7CFF00",
            "#58FF00",
            "#47FF00",
            "#24FF00",
            "#12FF00",
        ];

        function getColor(polarity) {
            var roundedVal = Math.round(polarity * 10);
            var positionOfYellow = 10;
            if (roundedVal === 0) {
                return colours[positionOfYellow];
            }
            else if (roundedVal < 0) {
                return colours[positionOfYellow + (roundedVal)];
            }
            else {
                return colours[positionOfYellow + roundedVal];
            }
        }

        function roundToTwoDecimal(polarity) {
            return Math.round(polarity * 100) / 100;
        }


        function setStatistics(tweets_no, locations_no) {
            $('.tweets-stat').text(tweets_no);
            $('.locations-stat').text(locations_no);
            $('.average-stat').text(countAverage());
        }

        function countAverage() {
            return (polarity_sum / total_tweets).toFixed(2);
        }

        function setTopTweet(data, tag) {
            var path = " .most-tweet .timeline-panel .timeline-heading ";
            $(tag + path + ".timeline-title .polarity-stat").text(data.polarity);
            $(tag + path + ".timeline-title .stat-author").text(data.user.name);
            $(tag + path + " .stat-pic").prop('src', data.user.profile_image_url_https);
            $(tag + path + " .stat-date").text(data.created_at);
            $(tag + " .most-tweet .timeline-panel .stat-content").text(data.text);
        }

        function sendMessage() {

            $('.statistics-holder').show();
            deadline = new Date(Date.parse(new Date()) + 10 * 1000);
            initializeClock('clockdiv', deadline);

            var input = $('#query_phrase');
            var newSearchBtn = $('#new_search_btn');
            var searchBtn = $('#search-btn');
            initializeClock('clockdiv', deadline);

            input.prop('disabled', 'disabled');
            searchBtn.prop('disabled', 'disabled');

            newSearchBtn.removeClass('btn-default');
            newSearchBtn.addClass('btn-primary');
            newSearchBtn.prop('disabled', false);

            clearInterval(getDataInterval);

            socket.send(JSON.stringify({
                text: input.val(),
                user_name: "{{ user.get_username}}"
            }));

            var getDataInterval = setInterval(function () {
                deadline = new Date(Date.parse(new Date()) + 10 * 1000);
                initializeClock('clockdiv', deadline);
                socket.send(JSON.stringify({
                    text: input.val(),
                    user_name: "{{ user.get_username}}",
                    last_tweet_id: last_tweet_id
                }));
            }, 10000);
        }

        function createArrayOfInts(howMany) {
            var arr = [];
            for (var i = 0; i < howMany; i++) {
                arr.push((i + 1));
            }
            return arr;
        }

        $('#search-btn').click(sendMessage);

        {#        input.keypress(function (e) {#}
        {#            if (e.which == 13) {#}
        {#                sendMessage();#}
        {#            }#}
        {#        });#}

        socket.onopen = function open() {
            console.log('WebSockets connection created.');
        };

        socket.onmessage = function message(event) {
            var data = JSON.parse(event.data);
            if (data) {
                if (data[0] && last_tweet_id !== data[0].id) {
                    last_tweet_id = data[0].id;
                    var positive_per_call = 0;
                    var neutral_per_call = 0
                    var negative_per_call = 0;
                    data.forEach(function (tweet) {
                        total_tweets++;
                        //console.log(tweet.user.name);
                        var user = tweet.user;
                        var username = user.name;
                        var user_location = user.location;
                        var content = tweet.text;
                        var coordinates = tweet.geolocation;
                        var place = tweet.place;
                        var date = moment(new Date(tweet.created_at)).format('MMMM Do YYYY, h:mm:ss a');
                        var polarity = tweet.polarity;
                        var color = getColor(polarity);
                        polarity_sum += polarity;

                        if (polarity > 0) {
                            positive_tweets_count++;
                            positive_per_call++;
                        } else if (polarity < 0) {
                            negative_tweets_count++;
                            negative_per_call++;
                        } else {
                            neutral_tweets_count++;
                            neutral_per_call++;
                        }

                        if (polarity >= highest_polarity) {
                            most_positive_tweet = tweet;
                            highest_polarity = polarity;
                        }

                        if (polarity <= lowest_polarity) {
                            most_negative_tweet = tweet;
                            lowest_polarity = polarity;
                        }


                        //should be negative left positive right ?
                        var inverted = polarity >= 0 ? "timeline-inverted" : "";
                        if (coordinates || place) {
                            var lat, lng;
                            lat = coordinates ? coordinates.coordinates[0] : place.bounding_box.coordinates[0][0][1];
                            lng = coordinates ? coordinates.coordinates[1] : place.bounding_box.coordinates[0][0][0];
                            points.push(new google.maps.LatLng(lat, lng));
                            heatmap.setMap(map);
                            total_locations++;
                        }

                        "<div class='col-sm-2'><img src='" + user.profile_image_url_https + "'alt='Thumbnail Image' class='rounded-circle img-raised'> </div>"

                        $(".timeline").append(
                            '<li class =' + inverted + '> <div class=\"timeline-badge\" style=\"color:gray; background-color: ' + color + ';\"><i class=\"glyphicon glyphicon-check\">'
                            + roundToTwoDecimal(polarity) + '</i></div> <div class=\"timeline-panel\"> ' +
                            '<div class=\"timeline-heading\"><h4 class=\"timeline-title\">' +
                            '<img src=\"' + user.profile_image_url_https + '\"alt=\"Thumbnail Image\" class=\"rounded-circle img-raised timeline-user-pic\">' +
                            '<span class =\"title-username\">' + username + '</span></h4>' +
                            '<p> <small class=\"text-muted\"><i class=\"glyphicon glyphicon-time\">' +
                            '</i>' +
                            (user_location ? 'Assigned user location: ' + user_location + ',  ' : '') + date + " " + '</small> </p> </div> <div class=\"timeline-body\"> ' +
                            '<p>' + content +
                            '</p> ' +
                            '</div> ' +
                            '</div> ' +
                            '</li>'
                        );

                        setStatistics(total_tweets, total_locations);
                        setTopTweet(most_positive_tweet, ".positive-tweet");
                        setTopTweet(most_negative_tweet, ".negative-tweet");

                    });
                    calls_counter++;
                    positive_count_list.push(positive_per_call);
                    neutral_count_list.push(neutral_per_call);
                    negative_count_list.push(negative_per_call);
                    tweets_per_pull_list.push(positive_per_call + neutral_per_call + negative_per_call);
                    average_polarity_list.push(countAverage());
                }
                //half donut
                new Chartist.Pie('.pos-vs-neg-chart', {
                    series: [negative_tweets_count, neutral_tweets_count, positive_tweets_count]
                }, {
                    donut: true,
                    donutWidth: 60,
                    donutSolid: true,
                    startAngle: 270,
                    total: total_tweets * 2,
                    showLabel: true
                });


                var listOfCalls = createArrayOfInts(calls_counter);

                //how polarity
                new Chartist.Line('.polarity-per-pull', {
                    labels: listOfCalls,
                    series: [average_polarity_list]

                }, {
                    low: -1,
                    high: 1,
                    fullWidth: true,
                    chartPadding: {right: 40}
                });

                //how many tweets for each iteration
                new Chartist.Line('.tweets-per-pull', {
                    labels: listOfCalls,
                    series: [tweets_per_pull_list]

                }, {
                    fullWidth: true,
                    chartPadding: {right: 40}
                });

                new Chartist.Line('.count-over-time', {
                    labels: listOfCalls,
                    series: [
                        negative_count_list,
                        neutral_count_list,
                        positive_count_list
                    ]
                }, {
                    fullWidth: true,
                    chartPadding: {
                        right: 40
                    }
                });


            }

        };

        if (socket.readyState == WebSocket.OPEN) {
            socket.onopen();
        }

        function pageReload() {
            location.reload();
        }


        // charts


    </script>
{% endblock %}

